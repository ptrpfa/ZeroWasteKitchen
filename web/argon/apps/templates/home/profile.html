{% extends 'layouts/base.html' %}

{% block title %} Profile {% endblock title %}

{% block stylesheets %}
<style>
	  .badge {
			padding: 0.375rem 0.625rem;
			font-size: 0.75rem;
			font-weight: 600;
			line-height: 1;
    }

    .badge:hover {
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0 rgba(247, 250, 252, 0.5);
    }

		.dropdown-menu.wider {
        min-width: 400%;
    }

    #diet-restrictions-container{
        max-width: 300%;
        white-space: normal;
        position:absolute;
        background-color: #f8f9fe;
    }

</style>
{% endblock stylesheets %}

{% block content %}

<div class="header pb-6 d-flex align-items-center" style="min-height: 500px; background-image: url(/static/assets/img/theme/profile-cover.jpg); background-size: cover; background-position: center top;">
  <!-- Mask -->
  <span class="mask bg-gradient-default opacity-8"></span>
  <!-- Header container -->
  <div class="container-fluid d-flex align-items-center">
    <div class="row">
      <div class="col-lg-7 col-md-10">
        <h1 class="display-2 text-white">
          Hello {{ request.user.username }} !
        </h1>
        <p class="text-white mt-0 mb-5">This is your profile page. You can see the progress you've made with your work and manage your projects or assigned tasks</p>
      </div>
    </div>
  </div>
</div>
<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col-xl-8 order-xl-1">
      <div class="card">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col-8">
              <h3 class="mb-0">Edit profile</h3>
            </div>
          </div>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'update_profile' %}">
            {% csrf_token %}
            <h6 class="heading-small text-muted mb-4">User information</h6>
            <div class="pl-lg-4">
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label class="form-control-label" for="input-username">Username</label>
                    <input type="text" id="input-username" name="username" class="form-control" placeholder="Username" value="{{ request.user.username }}">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label class="form-control-label" for="input-email">Email address</label>
                    <input type="email" id="input-email" name="email" class="form-control" placeholder="{{ request.user.email }}">
                  </div>
                </div>
              </div>
            </div>
            <div class="text-right">
              <button type="submit" class="btn btn-primary my-4">Save changes</button>
            </div>
          </form>

         <!-- Dietary restriction field -->
          <h6 class="heading-small text-muted mb-4">Your Restrictions</h6>
          <div class="pl-lg-4">
            <form method="post" action="{% url 'update_restriction' %}">
              {% csrf_token %}
              <div class="form-group">
                <div class="input-group">
                  <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle w-200" type="button" id="diet-restriction-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      Select dietary restrictions
                    </button>
                    <div class="dropdown-menu wider" aria-labelledby="diet-restriction-dropdown">
                      <div class='dropdown-item' id="diet-restrictions-container">
												<div class="input-group input-group-alternative input-group-merge mb-2">
													<div class="input-group-prepend">
															<span class="input-group-text"><i class="fas fa-search"></i></span>
													</div>
													<input class="form-control form-control-sm" id="restrictions-search" placeholder="Search for a restriction.." type="text" id="search_bar" style="padding-left: 1.5em">
											</div>
                        {% for restriction in diet_restrictions %}
                        	<span class="badge badge-primary diet-restriction-option m-1" data-restriction="{{ restriction }}">{{ restriction }}</span>
                        {% endfor %}
												<p class="d-none" id="no-results-message">No restrictions found!ðŸ˜”</p>
                      </div>
                    </div>
                  </div>
                </div>
                <input type="hidden" id="diet-restrictions-input" name="diet_restrictions" value="{{ selected_diet_restrictions }}">
                <div id="selected-diet-restrictions-container">
                  {% for restriction in selected_diet_restrictions %}
                  	<span class="badge badge-pill badge-primary">{{ restriction }}</span>
                  {% endfor %}
                </div>
              </div>
              <div class="text-right">
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
          <br>
          <!-- Your Reviews -->
          <h6 class="heading-small text-muted mb-4">Your Reviews</h6>
          <div class="pl-lg-4">
            {% if reviews %}
            {% for review in reviews %}
            <div class="card mb-3">
              <div class="card-body">
                <form method="post" action="{% url 'update_review' review.ReviewID %}">
                  {% csrf_token %}
                  <div class="form-group">
                    <h1>{{ review.RecipeName }}</h1>
                  </div>                  
                  <div class="form-group">
                    <label for="rating">Ratings:</label>
                    <select class="form-control" id="rating" name="rating" required>
                      <option value="" disabled selected>{{review.Rating}}</option>
                      <option value="1" {% if review.Rating == 1 %}selected{% endif %}>1</option>
                      <option value="2" {% if review.Rating == 2 %}selected{% endif %}>2</option>
                      <option value="3" {% if review.Rating == 3 %}selected{% endif %}>3</option>
                      <option value="4" {% if review.Rating == 4 %}selected{% endif %}>4</option>
                      <option value="5" {% if review.Rating == 5 %}selected{% endif %}>5</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="text">Review:</label>
                    <textarea class="form-control" id="text" name="text" rows="3" required>{{ review.Text }}</textarea>
                  </div>
                  <div class="text-left">
                    <p class="card-review-id"><em>Review ID: {{ review.ReviewID }}</em></p>
                  </div>
                  <div class="text-right">
                    <button class="btn btn-primary">Save Changes</button>
                    <a href="{% url 'delete_review' review.ReviewID %}" class="btn btn-danger">Delete</a>
                  </div>
                </form>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <p>No reviews found.</p>
            {% endif %}
          </div>
          
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}

</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<!-- Include jQuery library -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  $(document).ready(function() {
    var selectedDietRestrictions = [];

    // Click event for adding diet restrictions
    $('.diet-restriction-option').click(function(e) {
      e.preventDefault();
      var restriction = $(this).data('restriction');
      if (selectedDietRestrictions.indexOf(restriction) === -1) {
        selectedDietRestrictions.push(restriction);
        var pill = $('<span class="badge badge-pill badge-primary">' + restriction + '</span>');
        $('#selected-diet-restrictions-container').append(pill);
        updateDietRestrictionsInput();
      } else {
        alert('This restriction is already selected.');
      }
    });
    // Click event for removing diet restrictions
    $('#selected-diet-restrictions-container').on('click', '.badge', function() {
      var restriction = $(this).text().trim();
      var index = selectedDietRestrictions.indexOf(restriction);
      if (index !== -1) {
        selectedDietRestrictions.splice(index, 1);
        $(this).remove();
        updateDietRestrictionsInput();
      }
    });
    // Function to update the hidden input field
    function updateDietRestrictionsInput() {
      $('#diet-restrictions-input').val(selectedDietRestrictions.join(','));
    }

    $('#restrictions-search').on('input', function() {
    	var input = $(this).val().toLowerCase();
			var noResultsMessage = $('#no-results-message');
			var hasMatch = false;

        // Iterate over each diet restriction span
      $('#diet-restrictions-container span.diet-restriction-option').each(function() {
				var restriction = $(this).text().toLowerCase();
				
				// Check if the restriction matches the input
				if (restriction.includes(input)) {
						$(this).show();
						hasMatch = true;  
				} else {
						$(this).hide();  
				}
			});
			if (hasMatch) {
        	noResultsMessage.addClass('d-none');
			} else {
				noResultsMessage.removeClass('d-none');
			}
    });
  });
</script>
{% endblock javascripts %}
